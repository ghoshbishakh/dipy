

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      
      <title>Deterministic Tracking with EuDX on ODF Peaks &mdash; dipy 0.12.0dev documentation</title>
      
    <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.12.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
      <link rel="top" title="dipy 0.12.0dev documentation" href="../index.html" /> 
    </head>
    <body role="document">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><img style="max-width:100px; margin-top: -7px;"
             src="../_static/images/dipy-logo.png"></a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="../index.html">Home</a></li>
              <li><a href="../stateoftheart.html">Overview</a></li>
              <li><a href="../examples_index.html">Gallery</a></li>
              <li><a href="../installation.html">Download</a></li>
              <li><a href="../subscribe.html">Subscribe</a></li>
              <li><a href="../developers.html">Developers</a></li>
              <li><a href="../cite.html">Cite</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>  
      <div class="container mainContainer">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 docCol">
            <div class="document main-doc">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body img-control" role="main">
                    
  <div class="section" id="deterministic-tracking-with-eudx-on-odf-peaks">
<span id="example-tracking-eudx-odf"></span><h1>Deterministic Tracking with EuDX on ODF Peaks<a class="headerlink" href="#deterministic-tracking-with-eudx-on-odf-peaks" title="Permalink to this headline">Â¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dipy has updated tools for fiber tracking. Our new machinery for fiber
tracking is featured in the example titled Introduction to Basic Tracking.
The tools demonstrated in this example are no longer actively being
maintained and will likely be deprecated at some point.</p>
</div>
<p>In this example we do deterministic fiber tracking on fields of ODF peaks. EuDX
<a class="reference internal" href="../reference/dipy.segment.html#id19" id="id1">[Garyfallidis12]</a> will be used for this.</p>
<p>This example requires importing example <cite>reconst_csa.py</cite> in order to run. EuDX was
primarily made with cpu efficiency in mind. The main idea can be used with any
model that is a child of OdfModel.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">reconst_csa</span> <span class="kn">import</span> <span class="n">csapeaks</span><span class="p">,</span> <span class="n">sphere</span>
</pre></div>
</div>
<p>This time we will not use FA as input to EuDX but we will use GFA (generalized FA),
which is more suited for ODF functions. Tracking will stop when GFA is less
than 0.2.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dipy.tracking.eudx</span> <span class="kn">import</span> <span class="n">EuDX</span>

<span class="n">eu</span> <span class="o">=</span> <span class="n">EuDX</span><span class="p">(</span><span class="n">csapeaks</span><span class="o">.</span><span class="n">gfa</span><span class="p">,</span>
          <span class="n">csapeaks</span><span class="o">.</span><span class="n">peak_indices</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
          <span class="n">seeds</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
          <span class="n">odf_vertices</span><span class="o">=</span><span class="n">sphere</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
          <span class="n">a_low</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">csa_streamlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">streamline</span> <span class="k">for</span> <span class="n">streamline</span> <span class="ow">in</span> <span class="n">eu</span><span class="p">]</span>
</pre></div>
</div>
<p>Now that we have our streamlines in memory we can save the results on the disk.
For this purpose we can use the TrackVis format (<code class="docutils literal"><span class="pre">*.trk</span></code>). First, we need to
create a header.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nib</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">trackvis</span><span class="o">.</span><span class="n">empty_header</span><span class="p">()</span>
<span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;voxel_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>
<span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;voxel_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LAS&#39;</span>
<span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csapeaks</span><span class="o">.</span><span class="n">gfa</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
<p>Save the streamlines.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">csa_streamlines_trk</span> <span class="o">=</span> <span class="p">((</span><span class="n">sl</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">csa_streamlines</span><span class="p">)</span>

<span class="n">csa_sl_fname</span> <span class="o">=</span> <span class="s1">&#39;csa_streamline.trk&#39;</span>

<span class="n">nib</span><span class="o">.</span><span class="n">trackvis</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">csa_sl_fname</span><span class="p">,</span> <span class="n">csa_streamlines_trk</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">points_space</span><span class="o">=</span><span class="s1">&#39;voxel&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Visualize the streamlines with fvtk (python vtk is required).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dipy.viz</span> <span class="kn">import</span> <span class="n">fvtk</span>
<span class="kn">from</span> <span class="nn">dipy.viz.colormap</span> <span class="kn">import</span> <span class="n">line_colors</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">ren</span><span class="p">()</span>

<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">csa_streamlines</span><span class="p">,</span> <span class="n">line_colors</span><span class="p">(</span><span class="n">csa_streamlines</span><span class="p">)))</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Saving illustration as tensor_tracks.png&#39;</span><span class="p">)</span>

<span class="n">fvtk</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s1">&#39;csa_tracking.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>
</pre></div>
</div>
<div class="figure align-center" id="id3">
<img alt="../_images/csa_tracking.png" src="../_images/csa_tracking.png" />
<p class="caption"><span class="caption-text"><strong>Deterministic streamlines with EuDX on ODF peaks field modulated by GFA</strong>.</span></p>
</div>
<p>It is also possible to use EuDX with multiple ODF peaks, which is very helpful when
tracking in crossing areas.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">eu</span> <span class="o">=</span> <span class="n">EuDX</span><span class="p">(</span><span class="n">csapeaks</span><span class="o">.</span><span class="n">peak_values</span><span class="p">,</span>
          <span class="n">csapeaks</span><span class="o">.</span><span class="n">peak_indices</span><span class="p">,</span>
          <span class="n">seeds</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
          <span class="n">odf_vertices</span><span class="o">=</span><span class="n">sphere</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span>
          <span class="n">ang_thr</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
          <span class="n">a_low</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">csa_streamlines_mult_peaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">streamline</span> <span class="k">for</span> <span class="n">streamline</span> <span class="ow">in</span> <span class="n">eu</span><span class="p">]</span>

<span class="n">fvtk</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">fvtk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">fvtk</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">csa_streamlines_mult_peaks</span><span class="p">,</span> <span class="n">line_colors</span><span class="p">(</span><span class="n">csa_streamlines_mult_peaks</span><span class="p">)))</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Saving illustration as csa_tracking_mpeaks.png&#39;</span><span class="p">)</span>

<span class="n">fvtk</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s1">&#39;csa_tracking_mpeaks.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">))</span>
</pre></div>
</div>
<div class="figure align-center" id="id4">
<img alt="../_images/csa_tracking_mpeaks.png" src="../_images/csa_tracking_mpeaks.png" />
<p class="caption"><span class="caption-text"><strong>Deterministic streamlines with EuDX on multiple ODF peaks</strong>.</span></p>
</div>
<table class="docutils citation" frame="void" id="garyfallidis12" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[Garyfallidis12]</a></td><td>Garyfallidis E., &#8220;Towards an accurate brain tractography&#8221;, PhD thesis, University of Cambridge, 2012.</td></tr>
</tbody>
</table>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../_downloads/tracking_eudx_odf.py" download=""><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the dipy source distribution under the
<code class="file docutils literal"><span class="pre">doc/examples/</span></code> directory.</p>
</div>
</div>


                  </div>
                </div>
              </div>

              <div class="clearer"></div>
            </div>
          </div>
          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 sidebarCol">
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        <h3> Site Navigation </h3>
        <ul>
          <li><a href="../documentation.html">Documentation</a></li>
          <li><a href="../devel/index.html">Development</a></li>
        </ul>

        <h3> NIPY Community </h3>
        <ul class="simple">
          <li><a class="reference external" href="http://nipy.org/">Community Home</a></li>
          <li><a class="reference external" href="http://nipy.org/software/projects/">NIPY Projects</a></li>
          <li><a class="reference external" href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing List</a></li>
          <li><a class="reference external" href="http://nipy.org/nipy/license.html">License</a></li>
        </ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples_built/tracking_eudx_odf.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
      </div>
    </div>
          </div>
        </div>
      </div>
      <footer class="footer">
        <div class="container footerContainer">
          <div class="bottomNav">
  <div class="related" role="navigation" aria-label="related navigation">
    
    <ul>
      <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
        accesskey="I">index</a></li>
      <li class="right" >
        <a href="../np-modindex.html" title="Python Module Index"
        >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dipy 0.12.0dev documentation</a> &raquo;</li> 
      </ul>
    </div>
          </div>
          <div class="footerContent" role="contentinfo">
          &copy; Copyright 2008-2015, dipy developers &lt;neuroimaging@python.org&gt;.
          Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
        </div>
        </div>
      </footer>
    </body>
    </html>