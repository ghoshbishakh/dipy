

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      
      <title>Parallel reconstruction using Q-Ball &mdash; dipy 0.12.0dev documentation</title>
      
    <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.12.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
      <link rel="top" title="dipy 0.12.0dev documentation" href="../index.html" /> 
    </head>
    <body role="document">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><img style="max-width:100px; margin-top: -7px;"
             src="../_static/images/dipy-logo.png"></a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="../index.html">Home</a></li>
              <li><a href="../stateoftheart.html">Overview</a></li>
              <li><a href="../examples_index.html">Gallery</a></li>
              <li><a href="../installation.html">Download</a></li>
              <li><a href="../subscribe.html">Subscribe</a></li>
              <li><a href="../developers.html">Developers</a></li>
              <li><a href="../cite.html">Cite</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>  
      <div class="container mainContainer">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 docCol">
            <div class="document main-doc">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body img-control" role="main">
                    
  <div class="section" id="parallel-reconstruction-using-q-ball">
<span id="example-reconst-csa-parallel"></span><h1>Parallel reconstruction using Q-Ball<a class="headerlink" href="#parallel-reconstruction-using-q-ball" title="Permalink to this headline">Â¶</a></h1>
<p>We show an example of parallel reconstruction using a Q-Ball Constant Solid
Angle model (see Aganj et. al (MRM 2010)) and <cite>peaks_from_model</cite>.</p>
<p>Import modules, fetch and read data, and compute the mask.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">fetch_stanford_hardi</span><span class="p">,</span> <span class="n">read_stanford_hardi</span><span class="p">,</span> <span class="n">get_sphere</span>
<span class="kn">from</span> <span class="nn">dipy.reconst.shm</span> <span class="kn">import</span> <span class="n">CsaOdfModel</span>
<span class="kn">from</span> <span class="nn">dipy.direction</span> <span class="kn">import</span> <span class="n">peaks_from_model</span>
<span class="kn">from</span> <span class="nn">dipy.segment.mask</span> <span class="kn">import</span> <span class="n">median_otsu</span>

<span class="n">fetch_stanford_hardi</span><span class="p">()</span>
<span class="n">img</span><span class="p">,</span> <span class="n">gtab</span> <span class="o">=</span> <span class="n">read_stanford_hardi</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>

<span class="n">maskdata</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">median_otsu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                             <span class="n">vol_idx</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">dilate</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>We instantiate our CSA model with spherical harmonic order of 4</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">csamodel</span> <span class="o">=</span> <span class="n">CsaOdfModel</span><span class="p">(</span><span class="n">gtab</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p><cite>Peaks_from_model</cite> is used to calculate properties of the ODFs (Orientation
Distribution Function) and return for
example the peaks and their indices, or GFA which is similar to FA but for ODF
based models. This function mainly needs a reconstruction model, the data and a
sphere as input. The sphere is an object that represents the spherical discrete
grid where the ODF values will be evaluated.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sphere</span> <span class="o">=</span> <span class="n">get_sphere</span><span class="p">(</span><span class="s1">&#39;symmetric724&#39;</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
<p>We will first run <cite>peaks_from_model</cite> using parallelism with 2 processes. If
<cite>nbr_processes</cite> is None (default option) then this function will find the total
number of processors from the operating system and use this number as
<cite>nbr_processes</cite>. Sometimes it makes sense to use only a few of the processes in
order to allow resources for other applications. However, most of the times
using the default option will be sufficient.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">csapeaks_parallel</span> <span class="o">=</span> <span class="n">peaks_from_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">csamodel</span><span class="p">,</span>
                                     <span class="n">data</span><span class="o">=</span><span class="n">maskdata</span><span class="p">,</span>
                                     <span class="n">sphere</span><span class="o">=</span><span class="n">sphere</span><span class="p">,</span>
                                     <span class="n">relative_peak_threshold</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                                     <span class="n">min_separation_angle</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                     <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                                     <span class="n">return_odf</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                     <span class="n">normalize_peaks</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                     <span class="n">npeaks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                     <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                     <span class="n">nbr_processes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">time_parallel</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;peaks_from_model using 2 processes ran in : &quot;</span> <span class="o">+</span>
      <span class="nb">str</span><span class="p">(</span><span class="n">time_parallel</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>peaks_from_model using 2 process ran in  : 114.333221912 seconds, using 2
process</p>
<p>If we don&#8217;t use parallelism then we need to set <cite>parallel=False</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">csapeaks</span> <span class="o">=</span> <span class="n">peaks_from_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">csamodel</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">maskdata</span><span class="p">,</span>
                            <span class="n">sphere</span><span class="o">=</span><span class="n">sphere</span><span class="p">,</span>
                            <span class="n">relative_peak_threshold</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">min_separation_angle</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                            <span class="n">return_odf</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">normalize_peaks</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">npeaks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">parallel</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">nbr_processes</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="n">time_single</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;peaks_from_model ran in : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_single</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>peaks_from_model ran in : 196.872478008 seconds</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;Speedup factor : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_single</span> <span class="o">/</span> <span class="n">time_parallel</span><span class="p">))</span>
</pre></div>
</div>
<p>Speedup factor : 1.72191839533</p>
<p>In Windows if you get a runtime error about frozen executable please start
your script by adding your code above in a <code class="docutils literal"><span class="pre">main</span></code> function and use:</p>
<dl class="docutils">
<dt>if __name__ == &#8216;__main__&#8217;:</dt>
<dd>import multiprocessing
multiprocessing.freeze_support()
main()</dd>
</dl>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../_downloads/reconst_csa_parallel.py" download=""><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the dipy source distribution under the
<code class="file docutils literal"><span class="pre">doc/examples/</span></code> directory.</p>
</div>
</div>


                  </div>
                </div>
              </div>

              <div class="clearer"></div>
            </div>
          </div>
          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 sidebarCol">
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        <h3> Site Navigation </h3>
        <ul>
          <li><a href="../documentation.html">Documentation</a></li>
          <li><a href="../devel/index.html">Development</a></li>
        </ul>

        <h3> NIPY Community </h3>
        <ul class="simple">
          <li><a class="reference external" href="http://nipy.org/">Community Home</a></li>
          <li><a class="reference external" href="http://nipy.org/software/projects/">NIPY Projects</a></li>
          <li><a class="reference external" href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing List</a></li>
          <li><a class="reference external" href="http://nipy.org/nipy/license.html">License</a></li>
        </ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples_built/reconst_csa_parallel.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
      </div>
    </div>
          </div>
        </div>
      </div>
      <footer class="footer">
        <div class="container footerContainer">
          <div class="bottomNav">
  <div class="related" role="navigation" aria-label="related navigation">
    
    <ul>
      <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
        accesskey="I">index</a></li>
      <li class="right" >
        <a href="../np-modindex.html" title="Python Module Index"
        >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dipy 0.12.0dev documentation</a> &raquo;</li> 
      </ul>
    </div>
          </div>
          <div class="footerContent" role="contentinfo">
          &copy; Copyright 2008-2015, dipy developers &lt;neuroimaging@python.org&gt;.
          Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
        </div>
        </div>
      </footer>
    </body>
    </html>