

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      
      <title>Advanced interactive visualization &mdash; dipy 0.12.0dev documentation</title>
      
    <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.12.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
      <link rel="top" title="dipy 0.12.0dev documentation" href="../index.html" /> 
    </head>
    <body role="document">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><img style="max-width:100px; margin-top: -7px;"
             src="../_static/images/dipy-logo.png"></a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="../index.html">Home</a></li>
              <li><a href="../stateoftheart.html">Overview</a></li>
              <li><a href="../examples_index.html">Gallery</a></li>
              <li><a href="../installation.html">Download</a></li>
              <li><a href="../subscribe.html">Subscribe</a></li>
              <li><a href="../developers.html">Developers</a></li>
              <li><a href="../cite.html">Cite</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>  
      <div class="container mainContainer">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 docCol">
            <div class="document main-doc">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body img-control" role="main">
                    
  <div class="section" id="advanced-interactive-visualization">
<span id="example-viz-advanced"></span><h1>Advanced interactive visualization<a class="headerlink" href="#advanced-interactive-visualization" title="Permalink to this headline">Â¶</a></h1>
<p>In DIPY we created a thin interface to access many of the capabilities
available in the Visualization Toolkit framework (VTK) but tailored to the
needs of structural and diffusion imaging. Initially the 3D visualization
module was named <code class="docutils literal"><span class="pre">fvtk</span></code>, meaning functions using vtk. This is still available
for backwards compatibility but now there is a more comprehensive way to access
the main functions using the following modules.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dipy.viz</span> <span class="kn">import</span> <span class="n">actor</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">widget</span>
</pre></div>
</div>
<p>In <code class="docutils literal"><span class="pre">window</span></code> we have all the objects that connect what needs to be rendered
to the display or the disk e.g., for saving screenshots. So, there you will find
key objects and functions like the <code class="docutils literal"><span class="pre">Renderer</span></code> class which holds and provides
access to all the actors and the <code class="docutils literal"><span class="pre">show</span></code> function which displays what is
in the renderer on a window. Also, this module provides access to functions
for opening/saving dialogs and printing screenshots (see <code class="docutils literal"><span class="pre">snapshot</span></code>).</p>
<p>In the <code class="docutils literal"><span class="pre">actor</span></code> module we can find all the different primitives e.g.,
streamtubes, lines, image slices, etc.</p>
<p>In the <code class="docutils literal"><span class="pre">widget</span></code> we have some other objects which allow to add buttons
and sliders and these interact both with windows and actors. Because of this
they need input from the operating system so they can process events.</p>
<p>Let&#8217;s get started. In this tutorial, we will visualize some bundles
together with FA or T1. We will be able to change the slices using
a <code class="docutils literal"><span class="pre">slider</span></code> widget.</p>
<p>First we need to fetch and load some datasets.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dipy.data.fetcher</span> <span class="kn">import</span> <span class="n">fetch_bundles_2_subjects</span><span class="p">,</span> <span class="n">read_bundles_2_subjects</span>

<span class="n">fetch_bundles_2_subjects</span><span class="p">()</span>
</pre></div>
</div>
<p>The following function outputs a dictionary with the required bundles e.g., af
left (left arcuate fasciculus) and maps, e.g., FA for a specific subject.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">read_bundles_2_subjects</span><span class="p">(</span><span class="s1">&#39;subj_1&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;fa&#39;</span><span class="p">],</span>
                              <span class="p">[</span><span class="s1">&#39;af.left&#39;</span><span class="p">,</span> <span class="s1">&#39;cst.right&#39;</span><span class="p">,</span> <span class="s1">&#39;cc_1&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>We will use 3 bundles, FA and the affine transformation that brings the voxel
coordinates to world coordinates (RAS 1mm).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">streamlines</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;af.left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cst.right&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cc_1&#39;</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fa&#39;</span><span class="p">]</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
<span class="n">affine</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;affine&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>With our current design it is easy to decide in which space you want the
streamlines and slices to appear. The default we have here is to appear in
world coordinates (RAS 1mm).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">world_coords</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>If we want to see the objects in native space we need to make sure that all
objects which are currently in world coordinates are transformed back to
native space using the inverse of the affine.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">world_coords</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">dipy.tracking.streamline</span> <span class="kn">import</span> <span class="n">transform_streamlines</span>
    <span class="n">streamlines</span> <span class="o">=</span> <span class="n">transform_streamlines</span><span class="p">(</span><span class="n">streamlines</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">affine</span><span class="p">))</span>
</pre></div>
</div>
<p>Now we create, a <code class="docutils literal"><span class="pre">Renderer</span></code> object and add the streamlines using the <code class="docutils literal"><span class="pre">line</span></code>
function and an image plane using the <code class="docutils literal"><span class="pre">slice</span></code> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ren</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">Renderer</span><span class="p">()</span>
<span class="n">stream_actor</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">streamlines</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">world_coords</span><span class="p">:</span>
    <span class="n">image_actor</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">image_actor</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">slicer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">affine</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also change also the opacity of the slicer</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">slicer_opacity</span> <span class="o">=</span> <span class="o">.</span><span class="mi">6</span>
<span class="n">image_actor</span><span class="o">.</span><span class="n">opacity</span><span class="p">(</span><span class="n">slicer_opacity</span><span class="p">)</span>
</pre></div>
</div>
<p>Connect the actors with the Renderer.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ren</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stream_actor</span><span class="p">)</span>
<span class="n">ren</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">image_actor</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we would like to change the position of the <code class="docutils literal"><span class="pre">image_actor</span></code> using a slider.
The sliders are widgets which require access to different areas of the
visualization pipeline and therefore we don&#8217;t recommend using them with
<code class="docutils literal"><span class="pre">show</span></code>. The more appropriate way is to use them with the <code class="docutils literal"><span class="pre">ShowManager</span></code>
object which allows accessing the pipeline in different areas. Here is how:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">show_m</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">ShowManager</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">900</span><span class="p">))</span>
<span class="n">show_m</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</pre></div>
</div>
<p>After we have initialized the <code class="docutils literal"><span class="pre">ShowManager</span></code> we can go ahead and create a
callback which will be given to the <code class="docutils literal"><span class="pre">slider</span></code> function.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">change_slice</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">get_value</span><span class="p">()))</span>
    <span class="n">image_actor</span><span class="o">.</span><span class="n">display_extent</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                               <span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="n">slider</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">slider</span><span class="p">(</span><span class="n">show_m</span><span class="o">.</span><span class="n">iren</span><span class="p">,</span> <span class="n">show_m</span><span class="o">.</span><span class="n">ren</span><span class="p">,</span>
                       <span class="n">callback</span><span class="o">=</span><span class="n">change_slice</span><span class="p">,</span>
                       <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                       <span class="n">max_value</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">value</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                       <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Move slice&quot;</span><span class="p">,</span>
                       <span class="n">right_normalized_pos</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">98</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
                       <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">label_format</span><span class="o">=</span><span class="s2">&quot;%0.lf&quot;</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                       <span class="n">selected_color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.86</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
</pre></div>
</div>
<p>Then, we can render all the widgets and everything else in the screen and
start the interaction using <code class="docutils literal"><span class="pre">show_m.start()</span></code>.</p>
<p>However, if you change the window size, the slider will not update its position
properly. The solution to this issue is to update the position of the slider
using its <code class="docutils literal"><span class="pre">place</span></code> method every time the window size changes.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">global</span> <span class="n">size</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">ren</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">win_callback</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">size</span>
    <span class="k">if</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="n">GetSize</span><span class="p">():</span>

        <span class="n">slider</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">ren</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>

<span class="n">show_m</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, please uncomment the following 3 lines so that you can interact with
the available 3D and 2D objects.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># show_m.add_window_callback(win_callback)</span>
<span class="c1"># show_m.render()</span>
<span class="c1"># show_m.start()</span>

<span class="n">ren</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ren</span><span class="o">.</span><span class="n">reset_clipping_range</span><span class="p">()</span>

<span class="n">window</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">ren</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s1">&#39;bundles_and_a_slice.png&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="mi">900</span><span class="p">),</span>
              <span class="n">reset_camera</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center" id="id1">
<img alt="../_images/bundles_and_a_slice.png" src="../_images/bundles_and_a_slice.png" />
<p class="caption"><span class="caption-text"><strong>A few bundles with interactive slicing</strong>.</span></p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">show_m</span>
</pre></div>
</div>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../_downloads/viz_advanced.py" download=""><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the dipy source distribution under the
<code class="file docutils literal"><span class="pre">doc/examples/</span></code> directory.</p>
</div>
</div>


                  </div>
                </div>
              </div>

              <div class="clearer"></div>
            </div>
          </div>
          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 sidebarCol">
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        <h3> Site Navigation </h3>
        <ul>
          <li><a href="../documentation.html">Documentation</a></li>
          <li><a href="../devel/index.html">Development</a></li>
        </ul>

        <h3> NIPY Community </h3>
        <ul class="simple">
          <li><a class="reference external" href="http://nipy.org/">Community Home</a></li>
          <li><a class="reference external" href="http://nipy.org/software/projects/">NIPY Projects</a></li>
          <li><a class="reference external" href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing List</a></li>
          <li><a class="reference external" href="http://nipy.org/nipy/license.html">License</a></li>
        </ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples_built/viz_advanced.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
      </div>
    </div>
          </div>
        </div>
      </div>
      <footer class="footer">
        <div class="container footerContainer">
          <div class="bottomNav">
  <div class="related" role="navigation" aria-label="related navigation">
    
    <ul>
      <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
        accesskey="I">index</a></li>
      <li class="right" >
        <a href="../np-modindex.html" title="Python Module Index"
        >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dipy 0.12.0dev documentation</a> &raquo;</li> 
      </ul>
    </div>
          </div>
          <div class="footerContent" role="contentinfo">
          &copy; Copyright 2008-2015, dipy developers &lt;neuroimaging@python.org&gt;.
          Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
        </div>
        </div>
      </footer>
    </body>
    </html>