

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      
      <title>Noise estimation using PIESNO &mdash; dipy 0.12.0dev documentation</title>
      
    <link rel="stylesheet" href="../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.12.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>
      <link rel="top" title="dipy 0.12.0dev documentation" href="../index.html" /> 
    </head>
    <body role="document">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><img style="max-width:100px; margin-top: -7px;"
             src="../_static/images/dipy-logo.png"></a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li><a href="../index.html">Home</a></li>
              <li><a href="../stateoftheart.html">Overview</a></li>
              <li><a href="../examples_index.html">Gallery</a></li>
              <li><a href="../installation.html">Download</a></li>
              <li><a href="../subscribe.html">Subscribe</a></li>
              <li><a href="../developers.html">Developers</a></li>
              <li><a href="../cite.html">Cite</a></li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>  
      <div class="container mainContainer">
        <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 docCol">
            <div class="document main-doc">
              <div class="documentwrapper">
                <div class="bodywrapper">
                  <div class="body img-control" role="main">
                    
  <div class="section" id="noise-estimation-using-piesno">
<span id="example-piesno"></span><h1>Noise estimation using PIESNO<a class="headerlink" href="#noise-estimation-using-piesno" title="Permalink to this headline">Â¶</a></h1>
<p>Often, one is interested in estimating the noise in the diffusion signal. One
of the methods to do this is the Probabilistic Identification and Estimation of
Noise (PIESNO) framework [Koay2009]. Using this method, one can detect the
standard deviation of the noise from diffusion-weighted imaging (DWI). PIESNO
also works with multiple channel DWI datasets that are acquired from N array
coils for both SENSE and GRAPPA reconstructions.</p>
<p>The PIESNO method works in two steps:</p>
<p>1) First, it finds voxels that are most likely background voxels. Intuitively,
these voxels have very similar diffusion-weighted intensities (up to some noise)
in the fourth dimension of the DWI dataset. White matter, gray matter or CSF
voxels have diffusion intensities that vary quite a lot across different
directions.</p>
<p>2) From these estimated background voxels and the input number of coils N,
PIESNO finds what sigma each Gaussian from each of the N coils would have
generated the observed Rician (N=1) or non-central Chi (N&gt;1) distributed noise
profile in the DWI datasets.</p>
<p>PIESNO makes an important assumption: the Gaussian noise standard deviation is
assumed to be uniform. The noise is uniform across multiple slice locations or
across multiple images of the same location.</p>
<p>For the full details, please refer to the original paper.</p>
<p>In this example, we will demonstrate the use of PIESNO with a 3-shell data-set.</p>
<p>We start by importing necessary modules and functions and loading the data:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">nibabel</span> <span class="kn">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">dipy.denoise.noise_estimate</span> <span class="kn">import</span> <span class="n">piesno</span>
<span class="kn">from</span> <span class="nn">dipy.data</span> <span class="kn">import</span> <span class="n">fetch_sherbrooke_3shell</span><span class="p">,</span> <span class="n">read_sherbrooke_3shell</span>


<span class="n">fetch_sherbrooke_3shell</span><span class="p">()</span>
<span class="n">img</span><span class="p">,</span> <span class="n">gtab</span> <span class="o">=</span> <span class="n">read_sherbrooke_3shell</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</pre></div>
</div>
<p>Now that we have fetched a dataset, we must call PIESNO with the right number
of coils used to acquire this dataset. It is also important to know what
was the parallel reconstruction algorithm used. Here, the data comes from a
GRAPPA reconstruction, was acquired with a 12-elements head coil available on
the Tim Trio Siemens, for which the 12 coil elements are combined into 4 groups
of 3 coil elements each. The signal is therefore received through 4 distinct
groups of receiver channels, yielding N = 4. Had we used a GE acquisition, we
would have used N=1 even if multiple channel coils are used because GE uses a
SENSE reconstruction, which has a Rician noise nature and thus N is always 1.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">sigma</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">piesno</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">return_mask</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">axial</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
<span class="n">axial_piesno</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">axial</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Axial slice of the b=0 data&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">axial_piesno</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Background voxels from the data&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;piesno.png&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center" id="id3">
<img alt="../_images/piesno.png" src="../_images/piesno.png" />
<p class="caption"><span class="caption-text"><strong>Showing the mid axial slice of the b=0 image (left) and estimated
background voxels (right) used to estimate the noise standard deviation</strong>.</span></p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">get_affine</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">get_header</span><span class="p">()),</span>
         <span class="s1">&#39;mask_piesno.nii.gz&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;The noise standard deviation is sigma= &#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;The std of the background is =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)]))</span>
</pre></div>
</div>
<p>Here, we obtained a noise standard deviation of 7.26. For comparison, a simple
standard deviation of all voxels in the estimated mask (as done in the previous
example <a class="reference internal" href="snr_in_cc.html#example-snr-in-cc"><span>SNR estimation for Diffusion-Weighted Images</span></a>) gives a value of 6.1.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>.. [Koay2009] Koay C.G., E. Ozarslan, C. Pierpaoli. Probabilistic
</pre></div>
</div>
<blockquote>
<div>Identification and Estimation of Noise (PIESNO): A
self-consistent approach and its applications in MRI.
JMR, 199(1):94-103, 2009.</div></blockquote>
<div class="admonition-example-source-code admonition">
<p class="first admonition-title">Example source code</p>
<p class="last">You can download <a class="reference download internal" href="../_downloads/piesno.py" download=""><code class="xref download docutils literal"><span class="pre">the</span> <span class="pre">full</span> <span class="pre">source</span> <span class="pre">code</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">example</span></code></a>.
This same script is also included in the dipy source distribution under the
<code class="file docutils literal"><span class="pre">doc/examples/</span></code> directory.</p>
</div>
</div>


                  </div>
                </div>
              </div>

              <div class="clearer"></div>
            </div>
          </div>
          <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3 sidebarCol">
    <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
      <div class="sphinxsidebarwrapper">
        <h3> Site Navigation </h3>
        <ul>
          <li><a href="../documentation.html">Documentation</a></li>
          <li><a href="../devel/index.html">Development</a></li>
        </ul>

        <h3> NIPY Community </h3>
        <ul class="simple">
          <li><a class="reference external" href="http://nipy.org/">Community Home</a></li>
          <li><a class="reference external" href="http://nipy.org/software/projects/">NIPY Projects</a></li>
          <li><a class="reference external" href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing List</a></li>
          <li><a class="reference external" href="http://nipy.org/nipy/license.html">License</a></li>
        </ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples_built/piesno.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
      </div>
    </div>
          </div>
        </div>
      </div>
      <footer class="footer">
        <div class="container footerContainer">
          <div class="bottomNav">
  <div class="related" role="navigation" aria-label="related navigation">
    
    <ul>
      <li class="right" style="margin-right: 10px">
        <a href="../genindex.html" title="General Index"
        accesskey="I">index</a></li>
      <li class="right" >
        <a href="../np-modindex.html" title="Python Module Index"
        >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">dipy 0.12.0dev documentation</a> &raquo;</li> 
      </ul>
    </div>
          </div>
          <div class="footerContent" role="contentinfo">
          &copy; Copyright 2008-2015, dipy developers &lt;neuroimaging@python.org&gt;.
          Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
        </div>
        </div>
      </footer>
    </body>
    </html>